sequenceDiagram
    participant Utilisateur
    participant WebApp (Session Streamlit)
    participant CLI (Session de Chat)
    participant SemanticRAGPipeline
    participant DataManager
    participant Stockage (Fichier/Blob)

    alt Flux Application Web
        Utilisateur->>WebApp: Démarre une nouvelle session de chat
        WebApp->>WebApp: Génère et stocke un 'conversation_id' unique dans l'état de session.

        loop Pour chaque message dans la conversation
            Utilisateur->>WebApp: Envoie un nouveau message.
            WebApp->>DataManager: get_conversation_history(conversation_id)
            DataManager->>Stockage: Lit tous les logs précédents pour le 'conversation_id' donné.
            Stockage-->>DataManager: Retourne les entrées de log correspondantes.
            DataManager-->>WebApp: Retourne l'historique formaté.
            WebApp->>SemanticRAGPipeline: process_query(query, history, conversation_id)
            note right of SemanticRAGPipeline: Le pipeline utilise l'historique pour la reformulation de la requête.
            SemanticRAGPipeline->>DataManager: save_conversation(...)
            DataManager->>Stockage: Ajoute la nouvelle question et réponse au log de la conversation.
            SemanticRAGPipeline-->>WebApp: Retourne la réponse générée.
            WebApp->>Utilisateur: Affiche la réponse.
        end
    end

    alt Flux Interface en Ligne de Commande (CLI)
        Utilisateur->>CLI: Exécute la commande 'chat'.
        CLI->>CLI: Crée un objet 'ChatSession' avec une liste d'historique en mémoire et un 'conversation_id' unique.

        loop Pour chaque message dans la conversation
            Utilisateur->>CLI: Saisit un nouveau message.
            CLI->>CLI: Construit une chaîne d'historique depuis sa liste en mémoire.
            CLI->>SemanticRAGPipeline: process_query(query, history, conversation_id)
            note right of SemanticRAGPipeline: Le pipeline utilise l'historique pour la reformulation de la requête.
            SemanticRAGPipeline->>DataManager: save_conversation(...)
            DataManager->>Stockage: Ajoute la nouvelle question et réponse au log de la conversation.
            SemanticRAGPipeline-->>CLI: Retourne la réponse générée.
            CLI->>CLI: Ajoute le nouvel échange à sa liste d'historique en mémoire.
            CLI->>Utilisateur: Affiche la réponse.
        end
    end